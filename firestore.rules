/**
 * @fileoverview Firestore Security Rules for EnTrans application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles,
 * transport requests, and transport offerings. Transport matches are secured
 * based on the ownership of associated requests and offerings. Authorization
 * decisions are made using the authenticated user's UID and denormalized data.
 *
 * Data Structure:
 * - User profiles are stored in `/users/{userId}`.
 * - Transport requests are stored in `/users/{userId}/transportRequests/{transportRequestId}`.
 * - Transport offerings are stored in `/users/{userId}/transportOfferings/{transportOfferingId}`.
 * - Transport matches are stored in `/transportMatches/{transportMatchId}`. Each document
 *   contains denormalized `userProfileId` from the associated `TransportRequest` and
 *   `TransportOffering` documents to ensure authorization independence.
 * - Blog posts are stored in `/blogPosts/{blogPostId}`.
 * - Registration requests are stored in `/registrationRequests/{requestId}`.
 *
 * Key Security Decisions:
 * - Users can only create, read, update, and delete their own profiles.
 * - Administrators can read all user profiles and create new ones.
 * - Listing of transport requests and offerings is restricted to the owning user.
 * - Transport matches are secured by checking the user's ownership of the associated
 *   transport request or offering using the denormalized `userProfileId` field.
 * - Blog posts can be read by anyone, but only created, updated, and deleted by their authors.
 * - Data validation is limited to authorization-critical fields like `id`, `userProfileId`, and `role`.
 * - The rules explicitly deny any unauthorized access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'administrador';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      // Allow an admin to create any user profile.
      // Allow a user to update their own profile.
      allow create: if isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      // Only an admin can delete a user, and not themselves.
      allow delete: if isAdmin() && resource.data.id != request.auth.uid;
    }

    match /registrationRequests/{requestId} {
      allow create: if true; // Anyone can request to register
      allow read, list, delete: if isAdmin();
    }

    match /users/{userId}/transportRequests/{transportRequestId} {
      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userProfileId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userProfileId == resource.data.userProfileId;
      allow delete: if isExistingOwner(userId);
    }

    match /users/{userId}/transportOfferings/{transportOfferingId} {
      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userProfileId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userProfileId == resource.data.userProfileId;
      allow delete: if isExistingOwner(userId);
    }

    match /transportMatches/{transportMatchId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource != null;
        allow delete: if isSignedIn() && resource != null;
    }

    match /blogPosts/{blogPostId} {
      function isAuthor() {
          return request.auth.uid == resource.data.authorId;
      }
      
      allow read: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isSignedIn() && isAuthor();
    }
  }
}

    